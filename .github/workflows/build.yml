name: Build phone-caster & car-receiver APKs
on: [workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 55

    steps:
      - uses: actions/checkout@v4

      - name: List repo root (debug)
        run: |
          echo "== REPO ROOT =="
          ls -la

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      # 1) 自动找到仓库根目录里的任意 zip
      - name: Locate project ZIP
        id: zip
        shell: bash
        run: |
          set -e
          ZIP=$(find . -maxdepth 1 -type f -name "*.zip" | head -n1 || true)
          if [ -z "$ZIP" ]; then
            echo "❌ 根目录没有 .zip 文件"; exit 1
          fi
          echo "Using ZIP: $ZIP"
          echo "ZIP=$ZIP" | tee -a $GITHUB_OUTPUT

      # 2) 解压并打印结构
      - name: Unzip project ZIP
        run: |
          set -e
          unzip -q "${{ steps.zip.outputs.ZIP }}" -d srczip
          echo "== Unzipped to srczip (depth 5) =="
          find srczip -maxdepth 5 -printf "%y %p\n" | sed -e 's/^/  /'

      # 3) 查找名为 phone-caster / car-receiver 的工程（允许嵌套）
      - name: Detect Android projects in ZIP (nested-aware)
        id: detect
        shell: bash
        run: |
          set -e
          find_one() {
            local name="$1"
            local got=""
            while IFS= read -r d; do
              if { test -f "$d/settings.gradle" || test -f "$d/settings.gradle.kts"; } \
                 && { test -d "$d/app" || test -f "$d/app/build.gradle" || test -f "$d/app/build.gradle.kts"; }; then
                got="$d"; break
              fi
            done < <(find srczip -type d -name "$name")
            echo "$got"
          }

          PHONE_DIR="$(find_one phone-caster)"
          CAR_DIR="$(find_one car-receiver)"

          echo "Found:"
          echo "  phone-caster -> ${PHONE_DIR:-<none>}"
          echo "  car-receiver -> ${CAR_DIR:-<none>}"

          if [ -z "$PHONE_DIR" ] || [ -z "$CAR_DIR" ]; then
            echo "❌ 没找到 phone-caster 或 car-receiver（需要 settings.gradle* 与 app 模块）"; exit 1
          fi

          echo "PHONE_DIR=$PHONE_DIR"   | tee -a $GITHUB_OUTPUT
          echo "CAR_DIR=$CAR_DIR"       | tee -a $GITHUB_OUTPUT

      # 4) 规范化到固定目录
      - name: Normalize project folders
        run: |
          set -e
          rm -rf phone-caster car-receiver
          rsync -a "${{ steps.detect.outputs.PHONE_DIR }}/"   phone-caster/
          rsync -a "${{ steps.detect.outputs.CAR_DIR }}/"     car-receiver/
          echo "== phone-caster top =="
          ls -la phone-caster | head -n 120
          echo "== car-receiver top =="
          ls -la car-receiver | head -n 120

      # 5) 若项目没有 wrapper：多镜像兜底下载 Gradle，自举生成 wrapper，并替换分发镜像
      - name: Bootstrap Gradle wrapper if missing (both projects)
        shell: bash
        run: |
          set -e

          download_gradle () {
            local ver="$1"
            local out="$2"
            local urls=(
              "https://mirrors.cloud.tencent.com/gradle/gradle-${ver}-bin.zip"
              "https://services.gradle.org/distributions/gradle-${ver}-bin.zip"
              "https://downloads.gradle-dn.com/distributions/gradle-${ver}-bin.zip"
            )
            for u in "${urls[@]}"; do
              echo "Trying: $u"
              if curl -4fL --retry 8 --retry-delay 2 --retry-all-errors --connect-timeout 20 -o "$out" "$u"; then
                echo "Downloaded from: $u"
                return 0
              fi
              echo "Failed: $u"
            done
            return 1
          }

          ensure_wrapper () {
            local proj="$1"
            echo "== ensure wrapper in $proj =="

            WRAP=$(find "$proj" -maxdepth 3 -type f -name "gradlew" | head -n1 || true)
            if [ -n "$WRAP" ]; then
              echo "✓ found existing gradlew at $WRAP"
              chmod +x "$WRAP" || true
              return 0
            fi

            echo "⚠️  no gradlew, bootstrap wrapper..."
            GVER="8.7"
            mkdir -p "$HOME/gradle-dl"
            cd "$HOME/gradle-dl"
            if [ ! -f "gradle-${GVER}-bin.zip" ]; then
              download_gradle "$GVER" "gradle-${GVER}-bin.zip" || { echo "❌ 所有镜像均下载失败"; exit 1; }
            fi
            rm -rf "gradle-${GVER}"
            unzip -q "gradle-${GVER}-bin.zip"
            export PATH="$HOME/gradle-dl/gradle-${GVER}/bin:$PATH"

            cd "$GITHUB_WORKSPACE/$proj"
            gradle --version || true
            gradle wrapper --gradle-version "$GVER"

            if [ -f "gradle/wrapper/gradle-wrapper.properties" ]; then
              # 首选腾讯云镜像
              sed -i 's#https://services.gradle.org/distributions#https://mirrors.cloud.tencent.com/gradle#g' gradle/wrapper/gradle-wrapper.properties
              echo "---- gradle/wrapper/gradle-wrapper.properties ----"
              cat gradle/wrapper/gradle-wrapper.properties
            fi
            chmod +x gradlew || true
          }

          ensure_wrapper phone-caster
          ensure_wrapper car-receiver

      # 6) 用（找到或生成的）wrapper 编译
      - name: Build phone-caster (debug)
        env:
          GRADLE_USER_HOME: ${{ github.workspace }}/.gradle-home
        run: |
          set -e
          cd phone-caster
          WRAP=$(find . -maxdepth 3 -type f -name "gradlew" | head -n1 || true)
          if [ -z "$WRAP" ]; then
            echo "❌ 仍未找到 gradlew"; find . -maxdepth 4 -printf "%y %p\n"; exit 1
          fi
          chmod +x "$WRAP"
          echo "Use wrapper: $WRAP"
          "$WRAP" --no-daemon --stacktrace assembleDebug

      - name: Build car-receiver (debug)
        env:
          GRADLE_USER_HOME: ${{ github.workspace }}/.gradle-home
        run: |
          set -e
          cd car-receiver
          WRAP=$(find . -maxdepth 3 -type f -name "gradlew" | head -n1 || true)
          if [ -z "$WRAP" ]; then
            echo "❌ 仍未找到 gradlew"; find . -maxdepth 4 -printf "%y %p\n"; exit 1
          fi
          chmod +x "$WRAP"
          echo "Use wrapper: $WRAP"
          "$WRAP" --no-daemon --stacktrace assembleDebug

      # 7) 收集 APK 打包
      - name: Collect APKs into a single ZIP
        run: |
          mkdir -p out
          cp phone-caster/app/build/outputs/apk/debug/*.apk out/phone-caster-debug.apk || true
          cp car-receiver/app/build/outputs/apk/debug/*.apk out/car-receiver-debug.apk || true
          (cd out && zip -9 -r apks.zip . && ls -la)

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: apks
          path: out/apks.zip
